---
title: "PAM Analysis ALL"
author: "Caroline Fleming"
date: "2023-07-21"
output: html_document
---

# Uploading packages and data
```{r packages}
library("lme4")
#install.packages("lmerTest")
library("lmerTest")
#install.packages("emmeans")
library("emmeans")
#install.packages("pbkrtest")
library("pbkrtest")
#reshape melts our datasets in the way we want
library("reshape2")
library("dplyr")
library("plyr")
library("tidyverse")
library("Rmisc")
library("ggplot2")
library("performance")
library("see")
library("ggrepel")
install.packages("glmmLasso")
library(glmmLasso)

#increase the number of results it will show
options(max.print=1000000) #this just prevents R from truncating the number of decimal places it will show you

```

```{r}
#Upload data
PAM_all <- read.csv("PAM_all_dead_deleted_all_controls_7_21_23.csv", header = TRUE) 
```

#Suggested data manipulations
```{r}
# we want dose_type, 0= control, 1 = ammonium, and 2= nitrate (make this a factor)
PAM_all <- PAM_all %>% mutate(dose_type = case_when(
    N_species == "CNTRL" ~ "0" , #need two equal signs
    N_species == "A" ~ "1" ,
    N_species == "N" ~ "2" ))

PAM_all$dose_type <- as.factor(PAM_all$dose_type)

# we want dose_level, 0= control, 1= NH4 low OR NO3 low, 2= NH4 medium OR NO3 medium, 3= NH4 high OR NO3 high

PAM_all <- PAM_all %>% mutate(dose_level = case_when(
    N_species == "CNTRL" ~ "0" , #need two equal signs
    N_species_dose == "A_5" |  N_species_dose == "N_1.5"  ~ "1" ,
    N_species_dose == "A_7.5" |  N_species_dose == "N_5"  ~ "2",
    N_species_dose == "A_10" |  N_species_dose == "N_18"  ~ "3" ))


#make date_coll a date with the % thingys
#PAM_all$date_coll <- as.POSIXct(PAM_all$date_coll, format="%m/%d/%Y")

# figure out what day 1 of each experiment was, make new column date_exp_start
PAM_all <- PAM_all %>% mutate(date_exp_start = case_when(
    exp_run_full == "1A" ~ "07/15/2022" , #need to have the full year for R to cooperate
    exp_run_full == "1B" ~ "07/17/2022" ,
   exp_run_full == "2A" ~ "08/04/2022" ,
   exp_run_full == "2B" ~ "08/09/2022" ,
   exp_run_full == "3A" ~ "08/21/2022" ,
   exp_run_full == "3B" ~ "08/25/2022" ,
    ))
#make sure that column is in the right date format with the %d%m%y
#PAM_all$date_exp_start <- as.POSIXct(PAM_all$date_exp_start, format="%m/%d/%Y")

# figure out the difference between date_coll and date_exp_start
# weirdly they all had to be in characters first?
PAM_all$date_coll_exp_diff <- as.numeric(difftime(as.POSIXct(PAM_all$date_exp_start, format="%m/%d/%Y"), as.POSIXct(PAM_all$date_coll, format="%m/%d/%Y")))
```


```{r}
#dose type should be a factor, dose level should be numeric
#if it is numeric, 2 is greater than 1 and 1 is greater than 0
#we want an ordinal component to dose_level

PAM_all$col_num <- as.factor(PAM_all$col_num)
PAM_all$jar_unique_ID <- as.factor(PAM_all$jar_unique_ID)

lmer_PAM_delta_1 <-  lmer(PAM_delta ~ as.factor(dose_type) + as.numeric(dose_level) + as.factor(dose_type)*as.numeric(dose_level) + as.factor(temp) + as.factor(food) + as.factor(sym_state) + (1|col_num) + (1|jar_unique_ID) + (1|exp_run_full), data=PAM_all)
summary(lmer_PAM_delta_1)

#Is there any interaction between sym state and dose
lmer_PAM_delta_2 <-  lmer(PAM_delta ~ as.factor(dose_type) + as.numeric(dose_level) + as.factor(dose_type)*as.numeric(dose_level) + as.numeric(dose_level)*as.factor(sym_state)+  as.factor(dose_type)*as.factor(sym_state)+ as.factor(temp) + as.factor(food) + as.factor(sym_state) + (1|col_num) + (1|jar_unique_ID) + (1|exp_run_full), data=PAM_all)
summary(lmer_PAM_delta)

install.packages("jtools")
install.packages("broom.mixed")
library(broom.mixed)
library(jtools)

#effect plot with confience intervals
plot_coefs(lmer_PAM_delta)


#new model, asking if dose overall matters
PAM_all$any_dose <- ((PAM_all$dose_type) !="0" )
summary(PAM_all$any_dose)
lmer_PAM_delta_1 <-  lmer(PAM_delta ~ as.factor(dose_type) + as.numeric(dose_level) + as.factor(any_dose)*as.numeric(dose_level) +  as.factor(temp) + as.factor(sym_state) + as.factor(food) + as.factor(temp)*as.factor(sym_state) + as.factor(sym_state) + (1|col_num) + (1|jar_unique_ID) + (1|exp_run_full), data=PAM_all)

summary(lmer_PAM_delta_1)

#of those that had a negative delta, what mattered?
# DO NOT INCLUDE, we just used this to figure out what interaction to test
#THIS SHOULD BE THE SAME MODEL AS MODEL 1, JUST FILTERING NEGATIVE OBSERVATIONS

PAM_all$any_dose <- ((PAM_all$dose_type) !="0" )
summary(PAM_all$any_dose)
lmer_PAM_delta_4 <-  lmer(PAM_delta ~ as.factor(dose_type) + as.numeric(dose_level) + as.factor(dose_type)*as.numeric(dose_level) + as.factor(temp) + as.factor(sym_state) + as.factor(food) + (1|col_num) + (1|jar_unique_ID) + (1|exp_run_full), data=subset(PAM_all, PAM_all$PAM_delta<0))
summary(lmer_PAM_delta_4)

PAM_neg_delta <-subset(PAM_all, PAM_all$PAM_delta<0)
table(PAM_neg_delta$temp,PAM_neg_delta$sym_state )

#temp and sym state may interact
# we knew that the sym states were going really differently
# we wanted to see if interacts with dose type or dose level
# we also think that high temp would effect symbiotic colonies more, increase sym population

#MY BIG BEAAAAUTIFUL MODEL
lmer_PAM_delta_5 <-  lmer(PAM_delta ~ as.factor(dose_type) + as.numeric(dose_level) + as.factor(any_dose)*as.numeric(dose_level) + as.numeric(dose_level)*as.factor(sym_state)+  as.factor(dose_type)*as.factor(sym_state)+ as.factor(temp)*as.factor(sym_state) + as.factor(temp) + as.factor(sym_state) + as.factor(food)  + as.factor(sym_state) + (1|col_num) + (1|jar_unique_ID) + (1|exp_run_full), data=PAM_all)

summary(lmer_PAM_delta_5)
#because we did minimal model selection, it is fair to report these p values
#confidence interval plot


```


#Lasso modeling with glmmLasso
```{r}
#Run our LASSO model, testing all possible interactions.

glmmLasso(points ~ transfer.spendings + ave.unfair.score
+ ball.possession + tackles
+ ave.attend + sold.out, rnd = list(team=~1),
lambda=50, data = soccer)


PAM_all$exp_run_full <-as.factor(PAM_all$exp_run_full)
PAM_lasso <-  glmmLasso(PAM_delta ~ date_coll_exp_diff + as.numeric(dose_type) + as.numeric(dose_level) + as.numeric(dose_type):as.numeric(dose_level) + as.numeric(temp) + as.factor(food) + as.factor(sym_state),rnd=list(col_num=~1, jar_unique_ID=~1, exp_run_full=~1), lambda=50, family = gaussian(link="identity"), data=PAM_all)

summary(PAM_lasso)
plot(PAM_lasso)

hist(PAM_all$PAM_delta)
library(forestmodel)
forest_model(PAM_lasso)

```


```{r}
gg_date_coll <- ggplot(PAM_all,
       aes(x = date_coll_exp_diff, y = PAM_delta)) +
    geom_point() +
    xlab("Diff between collected and first day of exp") +
    ylab("PAM_delta") +
    theme_bw() 

gg_date_coll 
```

