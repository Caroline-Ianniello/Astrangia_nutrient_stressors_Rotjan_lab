---
title: "Polyp Extension Score"
author: "CFI"
date: "2024-06-12"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r Loading all necessary packages}
setwd("C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/")
setwd(dirname(getwd())) #need to add this!
library("knitr")
require("knitr")
opts_knit$set(root.dir = "C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/")
setwd("C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/")
setwd(dirname(getwd())) 
getwd()
#install.packages("dplyr")
#compare with and without predictor
library("lme4")
#install.packages("lmerTest")
library("lmerTest")
#install.packages("emmeans")
library("emmeans")
#install.packages("pbkrtest")
library("pbkrtest")
#reshape melts our datasets in the way we want
library("reshape2")
library("dplyr")
library("plyr")
library("tidyverse")
library("Rmisc")
library("ggplot2")
#multiple response variables 
#check model with performance package
  #model tools R markdown
  #check for colinearity
  #r squared figures
#install.packages("performance")
#install.packages(c("rlang", "ggplot2", "performance", "dplyr", "ggrepel", "see"), dependencies = TRUE)
library("performance")
#install.packages("see")
library("see")
#install.packages("ggrepel")
library("ggrepel")
#install.packages("sjPlot") #for visualizing linear models
library(sjPlot)
library(MASS)
library(car)
library(outliers)
#gg effects
library(ggpubr)
#install.packages("ggpmisc")
library("ggpmisc")
library(devtools)
source_gist("524eade46135f6348140") #for the stat_smooth_func()


#increase the number of results it will show
options(max.print=1000000)
```


```{r Inputting data & making sure everything is organized correctly}
#opts_knit$set(root.dir = "C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/")
pes_all.data <- read.csv("C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/PES_all_06_26_24_dead_NAs.csv", header=TRUE, sep=",",stringsAsFactors = FALSE)
#pes_data_WIDE <- read.csv("C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/PES_all_06_12_24.csv", header=TRUE, sep=",",stringsAsFactors = FALSE)

#ALL DONE PRE PROCESSING, UPLOADING REFORMATTED DATA WITH NEW NITRATE CATEGORIES
# #long data to deal with PES repeated measures
# pes_all.data <- pes_all.data %>%
#   pivot_longer(
#     cols = starts_with("PES_day"),
#     names_to = "PES_day",
#     values_to = "PES_value"
#   )
# 
# #change PES_day to either 2, 6, or 10
# pes_all.data <- pes_all.data %>% mutate(PES_day = case_when(
#     PES_day=="PES_day2" ~ 2 , #need two equal signs
#     PES_day=="PES_day6" ~ 6 , #need two equal signs
#     PES_day=="PES_day10" ~ 10)) #need two equal signs
# 
# write.csv(pes_all.data, "C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/pes_all.data.csv")

#Create a NEW column for nitrate with new categories
pes_all.data <- pes_all.data %>%
mutate(NO3_category = case_when(
NO3_mean_observed < 6  ~ "Low" , #need two equal signs
NO3_mean_observed >= 6 ~ "Elevated" 
 )
)
 

```





```{r GLMER}
# Repeat measures GLMER -- Poisson dist with a log link

pes_all.data$sym_state <-  as.factor(pes_all.data$sym_state)
pes_all.data$food <-  as.factor(pes_all.data$food)
pes_all.data$temp <-  as.factor(pes_all.data$temp)
pes_all.data$NO3_category <-  as.factor(pes_all.data$NO3_category)
model_full <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp + NO3_category*food + sym_state*temp + sym_state*food + temp*food + (1|beetag_exprun), family=poisson, data=pes_all.data)
summary(model_full)
#Starved had significantly LOWER PES scores than fed (makes sense)
#corals at 20C had less activity
#syms at 30 degrees had an overall higher PES score
emmeans(model_full, specs=pairwise ~ sym_state*temp)
#sym corals at 30 had higher PES than Apo at 30 (emmeans tukey p= 0.0441)
#Apos at 30 had higher PES than Apo at 20 (emmeans tukey = 0.0183)

model_2 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp + NO3_category*food + sym_state*temp + sym_state*food + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_3 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp + NO3_category*food + sym_state*temp + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_4 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp + NO3_category*food  + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_5 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp  + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_6 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_7 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + (1|beetag_exprun), family=poisson, data=pes_all.data)
summary(model)
emmeans(model_7, specs=pairwise ~ sym_state*temp*food)

model_8 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp  + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_9 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_10 <- glmer(PES_value ~ PES_day + NO3_category + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_11 <- glmer(PES_value ~ PES_day + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_12 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + sym_state*temp + (1|beetag_exprun), family=poisson, data=pes_all.data)



AIC(model_full,  model_2, model_3, model_4, model_5, model_6, model_7, model_8, model_9, model_10, model_11, model_12)

#model 7 is the winner
anova(model_3, model_7, model_full) #but they are no different to each other




```

```{r Visualizations of PES}
hist(pes_all.data$PES_value)

#Group by temp and sym state and then re-plot?
pes_all.data_gg <- pes_all.data
pes_all.data_gg$temp_sym <- paste(pes_all.data_gg$temp, "_", pes_all.data_gg$sym_state)
pes_all.data_gg$temp_sym <- as.factor(pes_all.data_gg$temp_sym)
pes_all.data_gg$PES_day <- as.integer(pes_all.data_gg$PES_DAY)


#sum by TEMPERATURE AND SYM STATE
sum_nitrate_4<- summarySE(pes_all.data_gg, measurevar = "PES_value", groupvars = c("temp_sym", "PES_day", "NO3_category"), na.rm=T)
gg_nitrate_PES_4 <-ggplot(data = sum_nitrate_4,
       aes(x = PES_day,
           y = PES_value, col=temp_sym, shape=NO3_category, group=interaction(NO3_category, temp_sym))) +
     geom_point(size=5, position=position_dodge(width=0.5)) +
  geom_line(linewidth=1, position=position_dodge(width=0.5), linetype="dotted")+
   geom_errorbar(aes(ymin=PES_value-se, ymax=PES_value+se), width=0.6, size = 1, position=position_dodge(width=0.5)) +
    ggtitle ("Polyp Exension Score- Average by symbiotic state, temperature, and nitrate level") +
    theme(legend.position = "right",
          legend.title = element_text(size=12),
          axis.title = element_text(size = 10),
          legend.background = element_blank(),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          axis.text = element_text(size = 12)) +
    labs(x = "Day of experiment", 
         y = expression(paste("Average Polyp Exension Score")), 
         caption = "data represent mean +/- SEM" ) +
       # theme(legend.position="none")+
   scale_color_manual("Treatment", labels=c("Aposymbiotic 20째C","Symbiotic 20째C", "Aposymbiotic 30째C","Symbiotic 30째C"), values=c("#9E9187", "#D97018", "gray2" ,"#804310")) +
  scale_shape_manual("Nitrate Level", values=c(8,15)) +
  scale_x_continuous(breaks=seq(0,10,by=1))
gg_nitrate_PES_4


```


```{r}
# Repeat measures GLM anova -- Poisson dist with a log link

pes_all.data$sym_state <-  as.factor(pes_all.data$sym_state)
pes_all.data$food <-  as.factor(pes_all.data$food)
pes_all.data$temp <-  as.factor(pes_all.data$temp)
pes_all.data$NO3_category <-  as.numeric(pes_all.data$NO3_category)

model_full <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp + NO3_category*food + sym_state*temp + sym_state*food + temp*food + (1|beetag_exprun), family=poisson, data=pes_all.data)
summary(model_full)
#Starved had significantly LOWER PES scores than fed (makes sense)
#30 degrees had an lower PES (20 was higher)
emmeans(model_full, specs=pairwise ~ sym_state*temp) #the interaction of sym state and temp goes away in nitrate 

model_2 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp + NO3_category*food + sym_state*temp + sym_state*food + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_3 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp + NO3_category*food + sym_state*temp + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_4 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp + NO3_category*food  + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_5 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + NO3_category*temp  + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_6 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + NO3_category*sym_state + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_7 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + (1|beetag_exprun), family=poisson, data=pes_all.data)
summary(model_7)
emmeans(model_full, specs=pairwise ~ sym_state*temp)

model_8 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp  + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_9 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + (1|beetag_exprun), family=poisson, data=pes_all.data)


model_10 <- glmer(PES_value ~ PES_day + NO3_category + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_11 <- glmer(PES_value ~ PES_day + (1|beetag_exprun), family=poisson, data=pes_all.data)

model_12 <- glmer(PES_value ~ PES_day + NO3_category + sym_state + temp + food + sym_state*temp + (1|beetag_exprun), family=poisson, data=pes_all.data)



AIC(model_full,  model_2, model_3, model_4, model_5, model_6, model_7, model_8, model_9, model_10, model_11, model_12)


#model 7 is the clear winner
anova(model_7, model_full) #but they are no different to each other

#lets go with the full model 


```