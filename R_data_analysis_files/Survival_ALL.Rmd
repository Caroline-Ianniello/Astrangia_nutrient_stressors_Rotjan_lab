---
title: "Survival - Kaplan Meier"
author: "CFI"
date: "2024-06-12"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r Loading all necessary packages}
setwd("C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/")
setwd(dirname(getwd())) #need to add this!
library("knitr")
require("knitr")
opts_knit$set(root.dir = "C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/")
setwd("C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/")
setwd(dirname(getwd())) 
getwd()
#install.packages("dplyr")
#compare with and without predictor
library("lme4")
#install.packages("lmerTest")
library("lmerTest")
#install.packages("emmeans")
library("emmeans")
#install.packages("pbkrtest")
library("pbkrtest")
#reshape melts our datasets in the way we want
library("reshape2")
library("dplyr")
library("plyr")
library("tidyverse")
library("Rmisc")
library("ggplot2")
#multiple response variables 
#check model with performance package
  #model tools R markdown
  #check for colinearity
  #r squared figures
#install.packages("performance")
#install.packages(c("rlang", "ggplot2", "performance", "dplyr", "ggrepel", "see"), dependencies = TRUE)
library("performance")
#install.packages("see")
library("see")
#install.packages("ggrepel")
library("ggrepel")
#install.packages("sjPlot") #for visualizing linear models
library(sjPlot)
library(MASS)
library(car)
library(outliers)
#gg effects
library(ggpubr)
#install.packages("ggpmisc")
library("ggpmisc")
library(devtools)
source_gist("524eade46135f6348140") #for the stat_smooth_func()
#install.packages("survival")
library(survival)
#install.packages("glmnet")
library(glmnet)
#install.packages("survminer")
library(survminer)


#increase the number of results it will show
options(max.print=1000000)
```



```{r upload data}
survival_all.data <- read.csv("C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/Survival_06_12_24.csv", header=TRUE, sep=",",stringsAsFactors = FALSE)

```


```{r Pivot long to get each row have a survival for each coral}

#long data to deal with repeated measures
survival_all.data <- survival_all.data %>%
  pivot_longer(
    cols = starts_with("survival_day"),
    names_to = "Day",
    values_to = "Death"
  )

#change Day to either 1-12
survival_all.data <- survival_all.data %>% mutate(Day = case_when(
    Day=="survival_day1" ~ 1 , 
    Day=="survival_day2" ~ 2 , 
    Day=="survival_day3" ~ 3 , 
    Day=="survival_day4" ~ 4 , 
    Day=="survival_day5" ~ 5 , 
    Day=="survival_day6" ~ 6 , 
    Day=="survival_day7" ~ 7 , 
    Day=="survival_day8" ~ 8 , 
    Day=="survival_day9" ~ 9 , 
    Day=="survival_day10" ~ 10 , 
    Day=="survival_day11" ~ 11 , 
    Day=="survival_day12" ~ 12))

```

```{r Create ammonium and nitrate subsets}
survival_AMMONIUM.data<- survival_all.data %>%
  filter(N_species=="A")

survival_NITRATE.data<- survival_all.data %>%
  filter(N_species=="N")

```

```{r Ammonium Survival Model}
#make things the right type
survival_AMMONIUM.data$temp <- as.factor(survival_AMMONIUM.data$temp)
survival_AMMONIUM.data$N_dose <- as.numeric(survival_AMMONIUM.data$N_dose)
survival_AMMONIUM.data$food <- as.factor(survival_AMMONIUM.data$food)
survival_AMMONIUM.data$sym_state <- as.factor(survival_AMMONIUM.data$sym_state)

# Create a survival model to assess mortality over time by treatment with modeling data

km_fit <- survfit(Surv(Day, Death) ~ N_dose + sym_state + temp + food, data = survival_AMMONIUM.data)
summary(km_fit)

plot(km_fit, xlab = "Time", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve")


treat.mod_ammonium <- coxph(Surv(Day, Death) ~ N_dose + sym_state + temp + food, data=survival_AMMONIUM.data, control = coxph.control(iter.max = 1000))
# Summarize the model 
summary(treat.mod_ammonium)
#Nothing mattered! Though all the corals that died were Ammonium at high dose and 30C....hmmm.... (its only one coral so unforch we can't do stats on it)

#Now lets do a binomial regression JUST on day 5
survival_all.data_WIDE <- read.csv("C:/Users/carol/OneDrive/Documents/PhD Boston University 2019-/Astrangia_nutrient_stressors_Rotjan_lab/Data/Survival_06_12_24_for_logistic.csv", header=TRUE, sep=",",stringsAsFactors = FALSE)
survival_AMMONIUM.data_WIDE<- survival_all.data_WIDE %>%
  filter(N_species=="A")

survival_AMMONIUM.data_WIDE$temp <- as.factor(survival_AMMONIUM.data_WIDE$temp)
survival_AMMONIUM.data_WIDE$N_dose <- as.numeric(survival_AMMONIUM.data_WIDE$N_dose)
survival_AMMONIUM.data_WIDE$food <- as.factor(survival_AMMONIUM.data_WIDE$food)
survival_AMMONIUM.data_WIDE$sym_state <- as.factor(survival_AMMONIUM.data_WIDE$sym_state)
binoimal_ammonium_survival_GLM <- glmer(survival_day12 ~ N_dose + sym_state + temp + food + (1|beetag_exprun), family=binomial(link='logit'), data=survival_AMMONIUM.data_WIDE) #not havin it, theres only one death


```

# Ammonium death table 
```{r}
ammonium_deaths <- survival_AMMONIUM.data %>%
  filter(Death==1)

ammonium_death_table <- data.frame(count(ammonium_deaths$treat_ID))

```

```{r Nitrate Survival Model}
treat.mod_nitrate <- coxph(Surv(Day, Death) ~ N_dose + sym_state + temp + food + N_dose*sym_state + N_dose*temp + N_dose*food + sym_state*temp + sym_state*food, data=survival_NITRATE.data)
# Summarize the model 
summary(treat.mod_nitrate)
#N dose is significant -- higher doses more likely to die
#N dose x temperature -- more likely to die at 20 than 30! Woah

survival_NITRATE.data$treat_ID <- as.factor(survival_NITRATE.data$treat_ID)
levels_treatID <- data.frame(levels(survival_NITRATE.data$treat_ID))

nitrate_survfit <- survfit(Surv(Day, Death) ~ treat_ID, data = survival_NITRATE.data)
summary(nitrate_survfit)

# Plot kaplan meier survival function with ggplot
ggsurvplot(nitrate_survfit, # survival function
                conf.int = FALSE, # remove confidence intervals
                pval = FALSE, # do not include p value on plot
                surv.scale = "default", # or %
                legend_labs= c("N_0_20_F_A", "N_0_20_F_S", "N_0_20_S_A", "N_0_20_S_S", "N_0_30_F_A", "N_0_30_F_S", "N_0_30_S_A", "N_0_30_S_S", "N_1.5_20_F_A", "N_1.5_20_F_S", "N_1.5_20_S_A", "N_1.5_20_S_S", "N_1.5_30_F_A", "N_1.5_30_F_S", "N_1.5_30_S_A", "N_1.5_30_S_S", "N_18_20_F_A", "N_18_20_F_S", "N_18_20_S_A", "N_18_20_S_S", "N_18_30_F_A", "N_18_30_F_S", "N_18_30_S_A", "N_18_30_S_S", "N_5_20_F_A", "N_5_20_F_S", "N_5_20_S_A", "N_5_20_S_S", "N_5_30_F_A", "N_5_30_F_S", "N_5_30_S_A", "N_5_30_S_S"), 
                legend = c(0.75, 0.5), font.legend = 10, legend.title ="", # legend parameters 
                xlab = "Day", xlim = c(0, 23), break.x.by = 2, font.x = 14, # x axis parameters
                ylim = c(0.4,1), font.y= 14, # y axis parameters
                font.tickslab = 14,
                censor.size = 6,
                ggtheme = theme_classic2(),
                title = "Nitrate Survival")
         #       palette = c("#131513","#F53100", "#FF8B47","#C39809","#F6CB3C",
                      #      "#0B8454", "#7BB12F","#3F88C5","#A33461"))


```

# Nitrate table 
```{r}
nitrate_deaths <- survival_NITRATE.data %>%
  filter(Death==1 & Day==12)

nitrate_death_table <- data.frame(count(nitrate_deaths$treat_ID))

```

